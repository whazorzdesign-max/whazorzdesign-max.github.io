<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoW Character Studio 3D v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <style>
        :root { --panel-bg: rgba(20, 20, 20, 0.9); --accent: #ffd100; --border: #444; }
        body, html { margin: 0; padding: 0; height: 100%; background: #050505; color: #eee; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

        #studio-container { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; }

        /* Viewport Container */
        #viewport {
            position: relative;
            width: 90vw;
            height: 50.625vw;
            max-width: 1600px;
            max-height: 900px;
            background: #111;
            background-image: radial-gradient(circle, #1a1a1a 1px, transparent 1px);
            background-size: 30px 30px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
            z-index: 0;
        }

        /* The 3D Canvas itself */
        canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1; 
            pointer-events: none; /* Allow clicks to pass through to UI if needed */
        }

        /* UI Panels - Higher z-index to prevent overlap */
        .panel { 
            position: absolute; 
            background: var(--panel-bg); 
            border: 1px solid var(--border); 
            padding: 15px; 
            font-size: 11px; 
            z-index: 100; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            backdrop-filter: blur(10px); 
            pointer-events: auto;
        }

        .outliner { top: 20px; left: 20px; width: 200px; }
        .properties { top: 20px; right: 20px; width: 220px; }
        .timeline { bottom: 20px; left: 20px; right: 20px; height: 40px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }

        h4 { margin: 0 0 12px 0; color: var(--accent); font-size: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; opacity: 0.8; }
        .control-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; color: #888; font-size: 9px; }
        
        input[type="text"] { width: 100%; background: #000; color: #fff; border: 1px solid #444; padding: 8px; margin-bottom: 8px; box-sizing: border-box; }
        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; }
        
        button { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 8px; cursor: pointer; margin-top: 5px; font-size: 10px; transition: 0.2s; }
        button:hover { background: var(--accent); color: black; border-color: var(--accent); }
        .search-trigger { background: var(--accent); color: black; font-weight: bold; margin-top: 10px; }

        #status { font-family: monospace; font-size: 10px; display: flex; align-items: center; }
        .status-dot { height: 8px; width: 8px; background-color: #555; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .active-dot { background-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
    </style>
</head>
<body>

<div id="studio-container">
    <div id="viewport">
        <div class="panel outliner">
            <h4>Scene Explorer</h4>
            <div style="color:var(--accent); margin-bottom: 5px;">▼ Scene_Root</div>
            <div style="padding-left:15px; color:#aaa;">├─ WebGL_Renderer</div>
            <div style="padding-left:15px; color:#aaa;">├─ Dynamic_Light</div>
            <div style="padding-left:15px; color:#aaa;">└─ Mesh_Character</div>
            <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
            <h4>Import</h4>
            <input type="text" id="name" placeholder="CHARACTER NAME">
            <input type="text" id="realm" placeholder="REALM">
            <button class="search-trigger" onclick="fetchChar()">LOAD 3D ASSET</button>
        </div>

        <div class="panel properties">
            <h4>Transform</h4>
            <div class="control-group">
                <label>Model Scale</label>
                <input type="range" id="scale" min="0.5" max="3" step="0.1" value="1.5" oninput="updateTransform()">
                <label>Rotation (Y-Axis)</label>
                <input type="range" id="rotate" min="-180" max="180" step="1" value="0" oninput="updateTransform()">
            </div>

            <h4>Lighting & Engine</h4>
            <button onclick="toggleShadows()">Toggle Soft Shadows</button>
            <button onclick="resetCamera()">Reset Camera</button>
        </div>

        <div class="panel timeline">
            <div id="status"><span class="status-dot" id="dot"></span>STATUS: ENGINE_READY</div>
            <div style="font-family: monospace; color: #666;">RENDERER: WEBGL_2.0 | SHADOWS: PCF_SOFT</div>
        </div>
    </div>
</div>

<script>
    // --- 3D ENGINE CONFIG ---
    let scene, camera, renderer, charMesh, pointLight, ground;
    const WORKER_URL = "https://my-worker.whazorz.workers.dev/";

    function initEngine() {
        const container = document.getElementById('viewport');
        
        // 1. Scene & Camera Setup
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(40, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 0.5, 6);

        // 2. Renderer Initialization
        renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Beautiful soft shadows
        container.appendChild(renderer.domElement);

        // 3. Lighting
        const ambient = new THREE.AmbientLight(0xffffff, 1.2); 
        scene.add(ambient);

        pointLight = new THREE.PointLight(0xffffff, 80);
        pointLight.position.set(2, 4, 5);
        pointLight.castShadow = true;
        // Sharpen the shadow map
        pointLight.shadow.mapSize.width = 1024;
        pointLight.shadow.mapSize.height = 1024;
        scene.add(pointLight);

        // 4. Ground Plane (Hidden, only for catching shadows)
        const groundGeo = new THREE.PlaneGeometry(20, 20);
        const groundMat = new THREE.ShadowMaterial({ opacity: 0.4 });
        ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -1.8;
        ground.receiveShadow = true;
        scene.add(ground);

        animate();
    }

    async function fetchChar() {
        const name = document.getElementById('name').value;
        const realm = document.getElementById('realm').value;
        const status = document.getElementById('status');
        const dot = document.getElementById('dot');
        
        if(!name || !realm) return;

        dot.className = "status-dot active-dot";
        status.innerText = "STATUS: FETCHING...";

        try {
            const res = await fetch(`${WORKER_URL}?name=${encodeURIComponent(name)}&realm=${encodeURIComponent(realm)}&region=eu`);
            const data = await res.json();
            const imgAsset = data.media.assets.find(a => a.key === "main-raw") || data.media.assets[0];
            
            loadModel(imgAsset.value);
            status.innerText = "STATUS: ASSET_LOADED";
        } catch(e) {
            dot.style.background = "red";
            status.innerText = "STATUS: ERROR";
        }
    }

    function loadModel(url) {
        const loader = new THREE.TextureLoader();
        loader.setCrossOrigin('anonymous');
        
        loader.load(url, (texture) => {
            if(charMesh) scene.remove(charMesh);

            // Create a plane that reacts to light
            const geometry = new THREE.PlaneGeometry(3.5, 4.5);
            const material = new THREE.MeshStandardMaterial({ 
                map: texture, 
                transparent: true, 
                side: THREE.DoubleSide,
                roughness: 0.8,
                metalness: 0.1,
                alphaTest: 0.5 // Prevents shadow box artifact
            });

            charMesh = new THREE.Mesh(geometry, material);
            charMesh.castShadow = true;
            charMesh.receiveShadow = true;
            charMesh.position.y = 0.4;
            
            scene.add(charMesh);
            updateTransform();
        });
    }

    function updateTransform() {
        if(!charMesh) return;
        const s = document.getElementById('scale').value;
        const r = document.getElementById('rotate').value;
        charMesh.scale.set(s, s, s);
        charMesh.rotation.y = r * (Math.PI / 180);
    }

    function animate() {
        requestAnimationFrame(animate);
        if(charMesh) {
            // Subtle "breathing" movement
            charMesh.position.y = 0.4 + Math.sin(Date.now() * 0.0015) * 0.05;
        }
        renderer.render(scene, camera); //
    }

    function resetCamera() {
        camera.position.set(0, 0.5, 6);
        camera.lookAt(0, 0, 0);
    }

    function toggleShadows() {
        renderer.shadowMap.enabled = !renderer.shadowMap.enabled;
        if(charMesh) charMesh.material.needsUpdate = true;
    }

    window.onload = initEngine;
</script>
</body>
</html>