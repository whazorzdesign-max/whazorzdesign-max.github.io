<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WoW Professional Armory Studio</title>
    <style>
        :root { --accent: #ffd100; --bg: #050505; --panel: rgba(12, 12, 12, 0.98); }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        #viewport {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90vw; height: 50.625vw; max-width: 1440px; max-height: 810px;
            background: #000; border: 1px solid #222; box-shadow: 0 0 80px #000;
        }

        .ui { position: absolute; background: var(--panel); border: 1px solid #333; padding: 15px; z-index: 100; pointer-events: all; }
        .left { top: 15px; left: 15px; width: 180px; }
        .right { top: 15px; right: 15px; width: 200px; }
        
        h4 { margin: 0 0 10px 0; color: var(--accent); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
        input, button { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 10px; margin-bottom: 8px; font-size: 11px; cursor: pointer; box-sizing: border-box; }
        button:hover { background: var(--accent); color: #000; font-weight: bold; }

        #load-bar { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); width: 350px; text-align: center; display: none; }
        .progress-bg { width: 100%; height: 2px; background: #111; margin-top: 5px; }
        #progress-fill { height: 100%; width: 0%; background: var(--accent); transition: 0.3s; box-shadow: 0 0 10px var(--accent); }
    </style>
</head>
<body>

<div id="viewport">
    <canvas id="c"></canvas>

    <div id="load-bar">
        <div id="status-msg" style="font-size: 9px; color: var(--accent);">CONNECTING TO WORKER...</div>
        <div class="progress-bg"><div id="progress-fill"></div></div>
    </div>

    <div class="panel left">
        <h4>Hierarchy</h4>
        <input id="name" placeholder="CHAR_NAME">
        <input id="realm" placeholder="REALM">
        <button onclick="runLoader()">EXECUTE_LOAD</button>
    </div>

    <div class="panel right">
        <h4>Material / AO</h4>
        <label style="font-size: 9px;">Ambient Intensity</label>
        <input type="range" id="ao-range" min="0" max="3" step="0.1" value="1.5">
        <button style="margin-top: 20px; background: #28a745;" onclick="saveImg()">Export Alpha PNG</button>
    </div>
</div>

<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    let scene, camera, renderer, composer, bloomPass, model, light;
    const worker = "https://my-worker.whazorz.workers.dev";

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(30, 16/9, 0.1, 1000);
        camera.position.z = 7;

        renderer = new THREE.WebGLRenderer({ 
            canvas: document.querySelector('#c'), 
            antialias: true, 
            alpha: true 
        });
        renderer.setSize(document.querySelector('#viewport').clientWidth, document.querySelector('#viewport').clientHeight);

        composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        composer.addPass(bloomPass);

        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        light = new THREE.PointLight(0xffffff, 50, 100);
        light.position.set(2, 2, 5);
        scene.add(light);

        window.addEventListener('mousemove', (e) => {
            if(!model) return;
            const x = (e.clientX / window.innerWidth) - 0.5;
            const y = (e.clientY / window.innerHeight) - 0.5;
            model.rotation.y = x * 0.5;
            model.rotation.x = -y * 0.3;
            light.position.set(x * 10, -y * 10, 5); // Dinamiskais AO apgaismojums
        });

        animate();
    }

    window.runLoader = async () => {
        const n = document.querySelector('#name').value;
        const r = document.querySelector('#realm').value;
        const bar = document.querySelector('#progress-fill');
        const msg = document.querySelector('#status-msg');
        
        document.querySelector('#load-bar').style.display = 'block';
        bar.style.width = '20%';
        msg.innerText = "QUERYING API...";

        try {
            const res = await fetch(`${worker}/?name=${n}&realm=${r}`);
            const data = await res.json();
            const imgUrl = data.media.assets.find(a => a.key === 'main-raw')?.value;

            msg.innerText = "STREAMING TEXTURE...";
            bar.style.width = '60%';

            // Apejam CORS: Sūtām X-Proxy-Target headerī
            const loader = new THREE.FileLoader();
            loader.setResponseType('blob');
            loader.setRequestHeader({ "X-Proxy-Target": imgUrl });

            loader.load(worker, (blob) => {
                const url = URL.createObjectURL(blob);
                new THREE.TextureLoader().load(url, (tex) => {
                    if(model) scene.remove(model);
                    const aspect = tex.image.width / tex.image.height;
                    const mat = new THREE.MeshStandardMaterial({ 
                        map: tex, 
                        transparent: true, 
                        roughness: 0.3,
                        metalness: 0.1 
                    });
                    model = new THREE.Mesh(new THREE.PlaneGeometry(3.8 * aspect, 3.8), mat);
                    scene.add(model);
                    
                    bar.style.width = '100%';
                    msg.innerText = "RENDER READY";
                    setTimeout(() => document.querySelector('#load-bar').style.display = 'none', 1000);
                });
            });
        } catch (e) {
            msg.innerText = "CONNECTION FAILED";
            bar.style.background = "red";
        }
    };

    window.saveImg = () => {
        composer.render();
        const link = document.createElement('a');
        link.download = 'armory_export.png';
        link.href = document.querySelector('#c').toDataURL();
        link.click();
    };

    function animate() {
        requestAnimationFrame(animate);
        bloomPass.strength = document.querySelector('#bloom').value || 1.5;
        if(model) model.material.emissiveIntensity = document.querySelector('#ao-range').value;
        composer.render();
    }
    init();
</script>
</body>
</html>