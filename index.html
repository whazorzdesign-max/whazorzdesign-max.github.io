<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WoW 3D Render Studio</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #050505; color: #aaa; font-family: 'Courier New', Courier, monospace; }
        
        /* 16:9 Viewport */
        #viewport-wrapper {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw; height: 50.625vw; /* 16:9 */
            max-width: 1440px; max-height: 810px;
            background: #111; border: 1px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,1);
            overflow: hidden;
        }

        /* 3D Canvas */
        #c { width: 100%; height: 100%; display: block; }

        /* UI Panels */
        .ui { position: absolute; background: rgba(20,20,20,0.9); border: 1px solid #333; padding: 10px; z-index: 10; pointer-events: all; }
        .left { top: 10px; left: 10px; width: 180px; bottom: 60px; }
        .right { top: 10px; right: 10px; width: 200px; bottom: 60px; }
        .bottom { bottom: 10px; left: 200px; right: 220px; height: 30px; text-align: center; font-size: 10px; }
        
        h4 { margin: 0 0 10px 0; color: #ffd100; font-size: 12px; border-bottom: 1px solid #333; }
        input, button { width: 100%; background: #000; border: 1px solid #444; color: #fff; margin-bottom: 5px; padding: 5px; font-size: 11px; }
        button:hover { background: #ffd100; color: #000; cursor: pointer; }
        label { font-size: 9px; display: block; margin: 10px 0 2px 0; }
    </style>
</head>
<body>

<div id="viewport-wrapper">
    <canvas id="c"></canvas>

    <div class="ui left">
        <h4>HIERARCHY</h4>
        <div style="color:#ffd100">▼ Scene</div>
        <div style="padding-left:10px">├─ ☼ AmbientLight</div>
        <div style="padding-left:10px">├─ ◓ PointLight</div>
        <div style="padding-left:10px; color:#fff">└─ ▣ Character_Mesh</div>
        <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
        <input type="text" id="name" placeholder="CHAR_NAME">
        <input type="text" id="realm" placeholder="REALM_NAME">
        <button onclick="loadCharacter()">LOAD ENTITY</button>
    </div>

    <div class="ui right">
        <h4>PROPERTIES</h4>
        <label>LIGHT INTENSITY</label>
        <input type="range" id="lightIntensity" min="0" max="5" step="0.1" value="2" oninput="updateScene()">
        <label>BONE VIZ (SKELETON)</label>
        <button onclick="toggleSkeleton()">TOGGLE SKELETON</button>
        <label>POSE (RANDOMIZE)</label>
        <button onclick="randomPose()">JITTER POSE</button>
        <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
        <button style="background:#28a745; color:#fff" onclick="downloadAlpha()">RENDER ALPHA PNG</button>
    </div>

    <div class="ui bottom">
        TIMELINE: 00:00:00:01 | FPS: 60 | RENDERER: THREE.JS_WEBGL
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    let scene, camera, renderer, characterPlane, pointLight, skeleton;
    const canvas = document.querySelector('#c');

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(35, 16/9, 0.1, 1000);
        camera.position.z = 5;

        renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        
        // Lighting
        const ambient = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambient);
        
        pointLight = new THREE.PointLight(0xffffff, 2);
        pointLight.position.set(2, 2, 2);
        scene.add(pointLight);

        animate();
    }

    async function loadCharacter() {
        const name = document.getElementById('name').value;
        const realm = document.getElementById('realm').value;
        
        const res = await fetch(`https://my-worker.whazorz.workers.dev/?name=${name}&realm=${realm}&region=eu`);
        const data = await res.json();
        
        if (data.media) {
            const url = data.media.assets.find(a => a.key === "main-raw")?.value || data.media.assets[0].value;
            
            // Create 3D Plane with Texture
            const loader = new THREE.TextureLoader();
            loader.crossOrigin = "anonymous";
            loader.load(url, (texture) => {
                if(characterPlane) scene.remove(characterPlane);
                
                // Aspect ratio fix
                const aspect = texture.image.width / texture.image.height;
                const geometry = new THREE.PlaneGeometry(3 * aspect, 3);
                
                // MeshPhongMaterial responds to light!
                const material = new THREE.MeshPhongMaterial({ 
                    map: texture, 
                    transparent: true, 
                    shininess: 100 
                });
                
                characterPlane = new THREE.Mesh(geometry, material);
                scene.add(characterPlane);
            });
        }
    }

    function updateScene() {
        pointLight.intensity = document.getElementById('lightIntensity').value;
    }

    // Mouse Tracking for 3D Tilt Effect
    window.addEventListener('mousemove', (e) => {
        if (!characterPlane) return;
        const x = (e.clientX / window.innerWidth) - 0.5;
        const y = (e.clientY / window.innerHeight) - 0.5;
        
        // Tilt the character plane
        characterPlane.rotation.y = x * 0.5;
        characterPlane.rotation.x = -y * 0.3;
        
        // Move light with mouse
        pointLight.position.x = x * 10;
        pointLight.position.y = -y * 10;
    });

    function randomPose() {
        if (!characterPlane) return;
        characterPlane.scale.set(1 + Math.random()*0.1, 1 + Math.random()*0.1, 1);
        characterPlane.rotation.z = (Math.random() - 0.5) * 0.1;
    }

    function downloadAlpha() {
        renderer.render(scene, camera);
        const link = document.createElement('a');
        link.download = '3d_studio_render.png';
        link.href = canvas.toDataURL("image/png");
        link.click();
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    init();
</script>
</body>
</html>