<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WoW 3D Character Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root { --panel-bg: rgba(30, 30, 30, 0.9); --accent: #ffd100; --border: #444; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #0a0a0a; color: #eee; font-family: 'Inter', sans-serif; overflow: hidden; }

        /* UI Overlay */
        #ui-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .panel { pointer-events: auto; position: absolute; background: var(--panel-bg); border: 1px solid var(--border); padding: 12px; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; }
        
        .outliner { top: 20px; left: 20px; width: 200px; }
        .properties { top: 20px; right: 20px; width: 220px; }
        .status-bar { bottom: 20px; left: 20px; right: 20px; height: 30px; display: flex; align-items: center; justify-content: space-between; }

        h4 { margin: 0 0 10px; color: var(--accent); font-size: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        input { width: 100%; background: #000; border: 1px solid #444; color: white; padding: 5px; margin-bottom: 8px; box-sizing: border-box; }
        button { width: 100%; background: #333; border: 1px solid #555; color: white; padding: 8px; cursor: pointer; margin-top: 5px; font-weight: bold; transition: 0.2s; }
        button:hover { background: var(--accent); color: black; }
        
        label { display: block; margin: 10px 0 5px; color: #888; font-size: 9px; }
        input[type="range"] { width: 100%; accent-color: var(--accent); }

        /* Canvas Stylings */
        #render-target { width: 100vw; height: 100vh; cursor: grab; }
        #render-target:active { cursor: grabbing; }
    </style>
</head>
<body>

<div id="ui-container">
    <div class="panel outliner">
        <h4>Data Source</h4>
        <input type="text" id="name" placeholder="CHARACTER NAME">
        <input type="text" id="realm" placeholder="REALM">
        <button onclick="fetchAndRender()">EXECUTE 3D GEN</button>
        
        <div style="margin-top:20px; color:#666; font-size:9px;">
            CONTROLS:<br>
            • LEFT CLICK: Rotate<br>
            • RIGHT CLICK: Pan<br>
            • SCROLL: Zoom
        </div>
    </div>

    <div class="panel properties">
        <h4>Transform</h4>
        <label>Vertical Tilt</label>
        <input type="range" id="rotX" min="-0.5" max="0.5" step="0.01" value="0">
        <label>Horizontal Spin</label>
        <input type="range" id="rotY" min="-3.14" max="3.14" step="0.01" value="0">
        
        <h4 style="margin-top:20px;">Render Engine</h4>
        <button style="background:#28a745; border:none;" onclick="downloadSnapshot()">Capture Alpha PNG</button>
        <button onclick="resetView()">Reset Camera</button>
    </div>

    <div class="panel status-bar">
        <div id="status">ENGINE: IDLE</div>
        <div id="char-name">NO SUBJECT LOADED</div>
    </div>
</div>

<div id="render-target"></div>

<script>
    let scene, camera, renderer, charObject;
    let isDragging = false;
    let prevMouse = { x: 0, y: 0 };

    // 1. Initialize 3D Environment
    function init() {
        scene = new THREE.Scene();
        
        camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 5);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('render-target').appendChild(renderer.domElement);

        // Lighting
        const light = new THREE.AmbientLight(0xffffff, 1.2);
        scene.add(light);

        // Grid Floor
        const grid = new THREE.GridHelper(10, 20, 0x333333, 0x111111);
        grid.position.y = -1.5;
        scene.add(grid);

        window.addEventListener('resize', onWindowResize);
        animate();
    }

    // 2. Fetch from your Worker and Generate 3D Plane
    async function fetchAndRender() {
        const name = document.getElementById('name').value;
        const realm = document.getElementById('realm').value;
        const status = document.getElementById('status');

        if(!name || !realm) return alert("Enter Name and Realm");

        status.innerText = "STATUS: CONNECTING TO WORKER...";

        try {
            // Using your exact worker URL pattern
            const response = await fetch(`https://my-worker.whazorz.workers.dev/?name=${name}&realm=${realm}&region=eu`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            // Find the best image asset (main-raw is usually best)
            const assets = data.media.assets;
            const imgUrl = assets.find(a => a.key === "main-raw")?.value || assets[0].value;

            const loader = new THREE.TextureLoader();
            loader.setCrossOrigin("anonymous");
            
            loader.load(imgUrl, (texture) => {
                create3DObject(texture);
                status.innerText = "STATUS: 3D GENERATED";
                document.getElementById('char-name').innerText = `${name.toUpperCase()} @ ${realm.toUpperCase()}`;
            });

        } catch (err) {
            status.innerText = "STATUS: ERROR";
            console.error(err);
        }
    }

    // 3. Create the 3D "Card" in space
    function create3DObject(texture) {
        if (charObject) scene.remove(charObject);

        const aspect = texture.image.width / texture.image.height;
        const geometry = new THREE.PlaneGeometry(3 * aspect, 3);
        const material = new THREE.MeshStandardMaterial({ 
            map: texture, 
            transparent: true, 
            side: THREE.DoubleSide,
            alphaTest: 0.1 // Removes the black border edges
        });

        charObject = new THREE.Mesh(geometry, material);
        scene.add(charObject);
    }

    // 4. Interaction Logic
    const canvas = document.getElementById('render-target');
    canvas.addEventListener('mousedown', () => isDragging = true);
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('mousemove', (e) => {
        if (isDragging && charObject) {
            charObject.rotation.y += (e.clientX - prevMouse.x) * 0.01;
            charObject.rotation.x += (e.clientY - prevMouse.y) * 0.01;
        }
        prevMouse = { x: e.clientX, y: e.clientY };
    });

    // Slider Listeners
    document.getElementById('rotY').addEventListener('input', (e) => {
        if(charObject) charObject.rotation.y = parseFloat(e.target.value);
    });
    document.getElementById('rotX').addEventListener('input', (e) => {
        if(charObject) charObject.rotation.x = parseFloat(e.target.value);
    });

    function resetView() {
        if(charObject) charObject.rotation.set(0,0,0);
        camera.position.set(0,0,5);
    }

    function downloadSnapshot() {
        const link = document.createElement('a');
        link.download = 'wow_capture.png';
        link.href = renderer.domElement.toDataURL("image/png");
        link.click();
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    init();
</script>

</body>
</html>