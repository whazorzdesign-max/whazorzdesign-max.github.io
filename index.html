<!DOCTYPE html>
<html>
<head>
    <title>WoW Ultra 3D Studio</title>
    <style>
        body, html { margin: 0; background: #000; color: #555; font-family: monospace; overflow: hidden; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; border: 1px solid #222; box-sizing: border-box; }
        .panel { position: absolute; background: rgba(10,10,10,0.9); border: 1px solid #333; padding: 10px; pointer-events: all; width: 180px; }
        .left { top: 20px; left: 20px; bottom: 60px; }
        .right { top: 20px; right: 20px; bottom: 60px; }
        input, button { width: 100%; background: #000; border: 1px solid #444; color: #fff; margin-top: 5px; padding: 5px; cursor: pointer; }
        #viewport { width: 100vw; height: 56.25vw; max-height: 100vh; margin: auto; display: block; }
    </style>
</head>
<body>
    <div id="ui-layer">
        <div class="panel left">
            <h4 style="color:#ffd100">SCENE_EXPLORER</h4>
            <input id="name" placeholder="CHAR_NAME">
            <input id="realm" placeholder="REALM">
            <button onclick="loadChar()">LOAD_ENTITY</button>
        </div>
        <div class="panel right">
            <h4 style="color:#ffd100">POST_PROCESSING</h4>
            <label>GLOW_STRENGTH</label>
            <input type="range" id="bloom" min="0" max="3" step="0.1" value="1.5">
            <button onclick="jitter()">JITTER_POSE</button>
            <button style="background:#28a745" onclick="snap()">ALPHA_RENDER</button>
        </div>
    </div>
    <canvas id="viewport"></canvas>

    <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        let scene, camera, renderer, composer, bloomPass, character;
        const canvas = document.querySelector('#viewport');

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(40, 16/9, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerWidth * (9/16));

            // Post Processing (Bloom)
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            composer.addPass(bloomPass);

            scene.add(new THREE.AmbientLight(0xffffff, 1));
            animate();
        }

        window.loadChar = async () => {
            const name = document.querySelector('#name').value;
            const realm = document.querySelector('#realm').value;
            const res = await fetch(`https://my-worker.whazorz.workers.dev/?name=${name}&realm=${realm}`);
            const data = await res.json();
            
            const raw = data.media.assets.find(a => a.key === 'main-raw')?.value;
            const proxied = `https://my-worker.whazorz.workers.dev/?proxyUrl=${encodeURIComponent(raw)}`;

            new THREE.TextureLoader().load(proxied, (tex) => {
                if(character) scene.remove(character);
                const aspect = tex.image.width / tex.image.height;
                character = new THREE.Mesh(new THREE.PlaneGeometry(3 * aspect, 3), new THREE.MeshBasicMaterial({ map: tex, transparent: true }));
                scene.add(character);
            });
        };

        window.jitter = () => { if(character) character.rotation.y += 0.1; };
        window.snap = () => {
            composer.render();
            const link = document.createElement('a');
            link.download = 'alpha_render.png';
            link.href = canvas.toDataURL();
            link.click();
        };

        function animate() {
            requestAnimationFrame(animate);
            bloomPass.strength = document.querySelector('#bloom').value;
            composer.render();
        }

        init();
    </script>
</body>
</html>