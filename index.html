<!DOCTYPE html>
<html>
<head>
    <title>WoW Studio Pro</title>
    <style>
        :root { --accent: #ffd100; --bg: #0a0a0a; }
        body, html { margin: 0; background: var(--bg); color: #fff; font-family: monospace; overflow: hidden; }
        
        /* 16:9 Studio Viewport */
        #studio-wrap { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90vw; height: 50.625vw; max-width: 1440px; max-height: 810px; border: 1px solid #333; overflow: hidden; }
        #v { width: 100%; height: 100%; display: block; }

        /* Loading Bar System */
        #load-container { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: 300px; display: none; z-index: 1000; text-align: center; }
        #load-text { font-size: 10px; margin-bottom: 5px; color: var(--accent); }
        #bar-bg { width: 100%; height: 4px; background: #222; border-radius: 2px; }
        #bar-fill { width: 0%; height: 100%; background: var(--accent); transition: width 0.2s; box-shadow: 0 0 10px var(--accent); }

        /* Panels */
        .panel { position: absolute; background: rgba(0,0,0,0.8); border: 1px solid #333; padding: 15px; width: 180px; z-index: 100; }
        .left { top: 20px; left: 20px; bottom: 20px; }
        .right { top: 20px; right: 20px; bottom: 20px; }
        input, button { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 8px; margin-bottom: 5px; cursor: pointer; font-size: 11px; }
        button:hover { background: var(--accent); color: #000; }
    </style>
</head>
<body>

<div id="studio-wrap">
    <canvas id="v"></canvas>

    <div id="load-container">
        <div id="load-text">FETCHING DATA...</div>
        <div id="bar-bg"><div id="bar-fill"></div></div>
    </div>

    <div class="panel left">
        <h4 style="color:var(--accent)">HIERARCHY</h4>
        <input id="name" placeholder="CHAR_NAME">
        <input id="realm" placeholder="REALM">
        <button onclick="startFetch()">EXECUTE_LOAD</button>
    </div>

    <div class="panel right">
        <h4 style="color:var(--accent)">EXPORT</h4>
        <button onclick="jitter()">RANDOM_POSE</button>
        <button style="background:#28a745" onclick="snap()">ALPHA_RENDER</button>
    </div>
</div>

<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    let scene, camera, renderer, composer, char;
    const canvas = document.querySelector('#v');
    const worker = "https://my-worker.whazorz.workers.dev";

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(40, 16/9, 0.1, 1000);
        camera.position.z = 5;
        renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);

        composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85));

        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        animate();
    }

    window.startFetch = async () => {
    const n = document.querySelector('#name').value;
    const r = document.querySelector('#realm').value;
    const bar = document.querySelector('#load-container');
    const fill = document.querySelector('#bar-fill');
    const txt = document.querySelector('#load-text');

    bar.style.display = 'block';
    fill.style.width = '10%';
    txt.innerText = "QUERYING WORKER...";

    try {
        const res = await fetch(`${worker}/?name=${n}&realm=${r}`);
        const data = await res.json();
        
        const rawImageUrl = data.media.assets.find(a => a.key === 'main-raw')?.value;
        
        // Use Headers to send the proxy target
        const manager = new THREE.LoadingManager();
        manager.onProgress = (url, loaded, total) => {
            const p = (loaded / total) * 50 + 50;
            fill.style.width = p + '%';
            txt.innerText = "3D TEXTURE LOAD: " + Math.round(p) + "%";
        };

        const loader = new THREE.TextureLoader(manager);
        
        // Pass the target URL in a custom header 'X-Proxy-Target'
        // We use the worker URL itself as the fetch target
        loader.load(
            worker, 
            (tex) => {
                if(char) scene.remove(char);
                const aspect = tex.image.width / tex.image.height;
                char = new THREE.Mesh(
                    new THREE.PlaneGeometry(3.5 * aspect, 3.5), 
                    new THREE.MeshPhongMaterial({ map: tex, transparent: true, shininess: 40 })
                );
                scene.add(char);
                txt.innerText = "RENDER COMPLETE";
                setTimeout(() => bar.style.display = 'none', 1500);
            },
            undefined,
            (err) => { throw new Error("Texture Proxy Failed"); },
            { "X-Proxy-Target": rawImageUrl } // THIS HEADER FIXES THE 400 ERROR
        );

    } catch (e) {
        txt.innerText = "CRITICAL ERROR: " + e.message;
        fill.style.background = "red";
    }
};

    window.jitter = () => { if(char) char.rotation.y += (Math.random()-0.5); };
    window.snap = () => {
        composer.render();
        const link = document.createElement('a');
        link.download = 'export.png';
        link.href = canvas.toDataURL();
        link.click();
    };

    function animate() { requestAnimationFrame(animate); composer.render(); }
    init();
</script>
</body>
</html>