<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoW Character Studio v2.1</title>
    
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
        }
    }
    </script>

    <style>
        :root { --panel-bg: rgba(15, 15, 15, 0.95); --accent: #ffd100; --border: #333; }
        body, html { margin: 0; padding: 0; height: 100%; background: #050505; color: #eee; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #studio-container { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; }
        #viewport { position: relative; width: 90vw; height: 50.625vw; background: #000; border: 1px solid var(--border); z-index: 0; }
        canvas { position: absolute; top: 0; left: 0; z-index: 1; }
        .panel { position: absolute; background: var(--panel-bg); border: 1px solid var(--border); padding: 15px; font-size: 11px; z-index: 100; backdrop-filter: blur(10px); }
        .outliner { top: 20px; left: 20px; width: 220px; }
        .properties { top: 20px; right: 20px; width: 220px; }
        input[type="text"] { width: 100%; background: #000; color: #fff; border: 1px solid #444; padding: 8px; margin-bottom: 5px; box-sizing: border-box; }
        button { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 8px; cursor: pointer; margin-top: 5px; font-size: 10px; transition: 0.2s; }
        button:hover { background: var(--accent); color: #000; }
    </style>
</head>
<body>

<div id="studio-container">
    <div id="viewport">
        <div class="panel outliner">
            <h4 style="color:var(--accent); margin:0 0 10px 0;">IMPORT MANAGER</h4>
            <input type="text" id="name" placeholder="Name">
            <input type="text" id="realm" placeholder="Realm">
            <button onclick="window.fetchChar()">IMPORT TO ENGINE</button>
        </div>
        <div class="panel properties">
            <h4 style="color:var(--accent); margin:0 0 10px 0;">TRANSFORM</h4>
            <input type="range" id="rotate" min="-180" max="180" value="0">
        </div>
    </div>
</div>

<script type="module">
    import * as THREE from 'three';

    let scene, camera, renderer, charMesh;
    const viewport = document.getElementById('viewport');

    // Use a multi-proxy fallback approach
    const PROXIES = [
        "https://api.allorigins.win/raw?url=",
        "https://corsproxy.io/?",
        "https://thingproxy.freeboard.io/fetch/"
    ];

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, viewport.clientWidth / viewport.clientHeight, 0.1, 1000);
        camera.position.set(0, 0, 5);

        renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        viewport.appendChild(renderer.domElement);

        const light = new THREE.PointLight(0xffffff, 100);
        light.position.set(2, 2, 5);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 1.2));

        animate();
    }

    window.fetchChar = async function() {
        const name = document.getElementById('name').value;
        const realm = document.getElementById('realm').value;
        const WORKER_URL = "https://my-worker.whazorz.workers.dev/";

        try {
            const res = await fetch(`${WORKER_URL}?name=${encodeURIComponent(name)}&realm=${encodeURIComponent(realm)}&region=eu`);
            const data = await res.json();
            const rawUrl = data.media.assets.find(a => a.key === "main-raw")?.value || data.media.assets[0].value;
            
            // Try the first proxy
            loadModel(PROXIES[0] + encodeURIComponent(rawUrl));
        } catch(e) { 
            console.error("Fetch failed", e); 
        }
    }

    function loadModel(url) {
        const loader = new THREE.TextureLoader();
        // Anonymous crossOrigin is essential for WebGL textures
        loader.setCrossOrigin('anonymous'); 

        loader.load(
            url, 
            (texture) => {
                if(charMesh) scene.remove(charMesh);
                const geo = new THREE.PlaneGeometry(3, 4);
                // alphaTest ensures transparent areas don't block shadows/lights
                const mat = new THREE.MeshStandardMaterial({ map: texture, transparent: true, alphaTest: 0.5 });
                charMesh = new THREE.Mesh(geo, mat);
                scene.add(charMesh);
            },
            undefined,
            (err) => {
                console.warn("Texture failed to load. Trying alternative proxy...");
                // Simple logic to try the second proxy if the first fails
                if (url.includes(encodeURIComponent(PROXIES[0]))) {
                    const originalUrl = decodeURIComponent(url.replace(PROXIES[0], ""));
                    loadModel(PROXIES[1] + encodeURIComponent(originalUrl));
                }
            }
        );
    }

    function animate() {
        requestAnimationFrame(animate);
        if(charMesh) {
            charMesh.rotation.y = document.getElementById('rotate').value * (Math.PI / 180);
        }
        renderer.render(scene, camera);
    }

    init();
</script>
</body>
</html>