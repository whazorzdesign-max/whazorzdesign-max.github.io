<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WoW Armory Professional v2.0</title>
    <style>
        :root { --accent: #ffd100; --panel: rgba(10, 10, 10, 0.95); --border: #333; }
        body, html { margin: 0; padding: 0; height: 100%; background: #050505; color: #fff; font-family: 'Inter', sans-serif; overflow: hidden; }

        /* 16:9 Viewport */
        #studio-frame {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90vw; height: 50.625vw; max-width: 1440px; max-height: 810px;
            background: #000; border: 1px solid var(--border); box-shadow: 0 0 100px #000; overflow: hidden;
        }

        #c { width: 100%; height: 100%; display: block; }

        /* UI Dizains */
        .panel { position: absolute; background: var(--panel); border: 1px solid var(--border); padding: 15px; z-index: 10; pointer-events: all; }
        .left { top: 15px; left: 15px; bottom: 60px; width: 200px; }
        .right { top: 15px; right: 15px; bottom: 60px; width: 220px; }
        .bottom { bottom: 15px; left: 15px; right: 15px; height: 35px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; font-size: 11px; color: #666; }

        h4 { margin: 0 0 12px 0; color: var(--accent); font-size: 10px; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        input, button { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 8px; margin-bottom: 8px; font-size: 11px; cursor: pointer; border-radius: 2px; }
        button:hover { background: var(--accent); color: #000; font-weight: bold; }
        
        #loading-bar { position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%); width: 300px; text-align: center; display: none; }
        #bar-fill { height: 2px; background: var(--accent); width: 0%; transition: 0.3s; box-shadow: 0 0 10px var(--accent); }
    </style>
</head>
<body>

<div id="studio-frame">
    <canvas id="c"></canvas>

    <div id="loading-bar">
        <div id="load-status" style="font-size: 10px; margin-bottom: 5px; color: var(--accent);">INITIALIZING...</div>
        <div style="width: 100%; height: 2px; background: #222;"><div id="bar-fill"></div></div>
    </div>

    <div class="panel left">
        <h4>Entity Explorer</h4>
        <input id="name" placeholder="CHARACTER_NAME">
        <input id="realm" placeholder="REALM">
        <button onclick="executeLoad()" style="background:var(--accent); color:#000;">LOAD ASSET</button>
        <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
        <div style="font-size:10px; color:#555">REGION: EU-WEST-1<br>ENGINE: THREE_JS<br>STATUS: <span id="sys-status">IDLE</span></div>
    </div>

    <div class="panel right">
        <h4>Render Properties</h4>
        <label style="font-size:10px">Bloom Strength</label>
        <input type="range" id="bloom" min="0" max="3" step="0.1" value="1.5">
        <button onclick="randomPose()">Jitter Pose</button>
        <button style="background:#28a745; color:white; border:none;" onclick="exportAlpha()">Download Alpha Render</button>
    </div>

    <div class="panel bottom">
        <div>FRAME: <span id="frame-count">0</span></div>
        <div style="color:var(--accent)">READY FOR EXPORT</div>
        <div>ARMORY_STUDIO_V2</div>
    </div>
</div>

<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    let scene, camera, renderer, composer, bloomPass, char, frame = 0;
    const worker = "https://my-worker.whazorz.workers.dev"; // TAVA WORKER ADRESE

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(35, 16/9, 0.1, 1000);
        camera.position.z = 5;

        renderer = new THREE.WebGLRenderer({ canvas: document.querySelector('#c'), antialias: true, alpha: true });
        renderer.setSize(document.querySelector('#studio-frame').clientWidth, document.querySelector('#studio-frame').clientHeight);

        composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        composer.addPass(bloomPass);

        scene.add(new THREE.AmbientLight(0xffffff, 1.5));
        animate();
    }

    window.executeLoad = async () => {
        const n = document.querySelector('#name').value;
        const r = document.querySelector('#realm').value;
        const fill = document.querySelector('#bar-fill');
        const txt = document.querySelector('#load-status');
        
        document.querySelector('#loading-bar').style.display = 'block';
        fill.style.width = '20%';
        txt.innerText = "FETCHING API DATA...";

        try {
            const res = await fetch(`${worker}/?name=${n}&realm=${r}`);
            const data = await res.json();
            const imgTarget = data.media.assets.find(a => a.key === 'main-raw')?.value;

            txt.innerText = "STREAMING TEXTURE VIA PROXY...";
            fill.style.width = '50%';

            // Apejam CORS kļūdu, izmantojot Headeri un FileLoader
            const loader = new THREE.FileLoader();
            loader.setResponseType('blob');
            loader.setRequestHeader({ "X-Proxy-Target": imgTarget });

            loader.load(worker, (blob) => {
                const url = URL.createObjectURL(blob);
                new THREE.TextureLoader().load(url, (tex) => {
                    if(char) scene.remove(char);
                    const aspect = tex.image.width / tex.image.height;
                    char = new THREE.Mesh(new THREE.PlaneGeometry(3.5 * aspect, 3.5), new THREE.MeshPhongMaterial({ map: tex, transparent: true, shininess: 30 }));
                    scene.add(char);
                    
                    fill.style.width = '100%';
                    txt.innerText = "RENDER READY";
                    document.querySelector('#sys-status').innerText = "STABLE";
                    setTimeout(() => document.querySelector('#loading-bar').style.display = 'none', 1000);
                });
            });
        } catch (e) {
            txt.innerText = "CRITICAL ERROR";
            fill.style.background = "red";
        }
    };

    window.randomPose = () => { if(char) char.rotation.y += (Math.random()-0.5) * 0.5; };
    window.exportAlpha = () => {
        composer.render();
        const link = document.createElement('a');
        link.download = 'armory_export.png';
        link.href = document.querySelector('#c').toDataURL();
        link.click();
    };

    function animate() {
        requestAnimationFrame(animate);
        frame++;
        document.querySelector('#frame-count').innerText = frame;
        bloomPass.strength = document.querySelector('#bloom').value;
        if(char) char.rotation.y += 0.002; // Lēna rotācija efektam
        composer.render();
    }

    init();
</script>
</body>
</html>