<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WoW Ultra-Precision 3D Studio</title>
    <style>
        :root { --accent: #ffd100; --bg: #050505; --panel: rgba(10, 10, 10, 0.98); }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; overflow: hidden; }

        #studio-viewport {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90vw; height: 50.625vw; max-width: 1440px; max-height: 810px;
            background: #000; border: 1px solid #222; overflow: hidden;
        }

        .panel { position: absolute; background: var(--panel); border: 1px solid #333; padding: 15px; z-index: 100; pointer-events: all; }
        .left { top: 15px; left: 15px; width: 190px; bottom: 80px; }
        .right { top: 15px; right: 15px; width: 220px; bottom: 80px; }
        
        h4 { margin: 0 0 10px 0; color: var(--accent); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
        input, button { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 10px; margin-bottom: 10px; font-size: 11px; cursor: pointer; box-sizing: border-box; }
        button:hover { background: var(--accent); color: #000; font-weight: bold; }

        #loader {
            position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%);
            width: 400px; text-align: center; z-index: 1000; display: none;
        }
        .bar-bg { width: 100%; height: 2px; background: #222; margin-top: 5px; }
        #bar-fill { height: 100%; width: 0%; background: var(--accent); transition: 0.2s; box-shadow: 0 0 15px var(--accent); }
    </style>
</head>
<body>

<div id="studio-viewport">
    <canvas id="main-canvas"></canvas>

    <div id="loader">
        <div id="load-txt" style="font-size: 9px; color: var(--accent); letter-spacing: 2px;">SYNCHRONIZING ASSETS...</div>
        <div class="bar-bg"><div id="bar-fill"></div></div>
    </div>

    <div class="panel left">
        <h4>Hierarchy</h4>
        <input id="charName" placeholder="NAME">
        <input id="charRealm" placeholder="REALM">
        <button onclick="bootSystem()">EXECUTE LOAD</button>
        <div style="font-size: 9px; color: #444; margin-top: 20px;">
            ENGINE: THREE_PRO_V2<br>AO_SIMULATION: ENABLED<br>CORS_PROXY: ACTIVE
        </div>
    </div>

    <div class="panel right">
        <h4>Material / FX</h4>
        <label style="font-size: 9px;">Ambient Occlusion</label>
        <input type="range" id="ao-strength" min="0" max="2" step="0.1" value="1.2">
        <label style="font-size: 9px;">Global Bloom</label>
        <input type="range" id="bloom" min="0" max="3" step="0.1" value="1.4">
        <button style="margin-top: 20px; background: #28a745; border: none;" onclick="capture()">Render Alpha</button>
    </div>
</div>

<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    let scene, camera, renderer, composer, bloomPass, charMesh, pointLight;
    const worker = "https://my-worker.whazorz.workers.dev";

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(30, 16/9, 0.1, 1000);
        camera.position.z = 7;

        renderer = new THREE.WebGLRenderer({ 
            canvas: document.querySelector('#main-canvas'), 
            antialias: true, 
            alpha: true,
            preserveDrawingBuffer: true 
        });
        renderer.setSize(document.querySelector('#studio-viewport').clientWidth, document.querySelector('#studio-viewport').clientHeight);

        // POST PROCESSING (Bloom + Depth Simulation)
        composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.4, 0.4, 0.85);
        composer.addPass(bloomPass);

        // AMBIENT LIGHTING (AO Bāze)
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        
        // DINAMISKAIS PUNKTA APGAISMOJUMS
        pointLight = new THREE.PointLight(0xffffff, 40, 100);
        pointLight.position.set(2, 2, 5);
        scene.add(pointLight);

        window.addEventListener('mousemove', (e) => {
            if(!charMesh) return;
            const x = (e.clientX / window.innerWidth) - 0.5;
            const y = (e.clientY / window.innerHeight) - 0.5;
            charMesh.rotation.y = x * 0.4;
            charMesh.rotation.x = -y * 0.2;
            pointLight.position.set(x * 10, -y * 10, 5);
        });

        animate();
    }

    window.bootSystem = async () => {
        const n = document.querySelector('#charName').value;
        const r = document.querySelector('#charRealm').value;
        const bar = document.querySelector('#bar-fill');
        const txt = document.querySelector('#load-txt');
        
        document.querySelector('#loader').style.display = 'block';
        bar.style.width = '20%';
        txt.innerText = "QUERYING BLIZZARD API...";

        try {
            const res = await fetch(`${worker}/?name=${n}&realm=${r}`);
            const data = await res.json();
            const imgUrl = data.media.assets.find(a => a.key === 'main-raw')?.value;

            txt.innerText = "NEUTRALIZING CORS & STREAMING TEXTURE...";
            bar.style.width = '50%';

            // LABOTS: Izmantojam FileLoader ar pareizajiem headeriem
            const loader = new THREE.FileLoader();
            loader.setResponseType('blob');
            loader.setRequestHeader({ "X-Proxy-Target": imgUrl });

            loader.load(worker, (blob) => {
                const url = URL.createObjectURL(blob);
                new THREE.TextureLoader().load(url, (tex) => {
                    if(charMesh) scene.remove(charMesh);
                    
                    const aspect = tex.image.width / tex.image.height;
                    const geo = new THREE.PlaneGeometry(3.5 * aspect, 3.5);
                    
                    // MeshStandardMaterial reaģē uz AO un gaismu labāk
                    const mat = new THREE.MeshStandardMaterial({ 
                        map: tex, 
                        transparent: true, 
                        roughness: 0.4,
                        metalness: 0.2
                    });

                    charMesh = new THREE.Mesh(geo, mat);
                    scene.add(charMesh);
                    
                    bar.style.width = '100%';
                    txt.innerText = "PRECISION RENDER COMPLETE";
                    setTimeout(() => document.querySelector('#loader').style.display = 'none', 1000);
                });
            });
        } catch (e) {
            txt.innerText = "CORE SYSTEM FAILURE";
            bar.style.background = "red";
        }
    };

    window.capture = () => {
        composer.render();
        const link = document.createElement('a');
        link.download = 'armory_high_res.png';
        link.href = document.querySelector('#main-canvas').toDataURL('image/png');
        link.click();
    };

    function animate() {
        requestAnimationFrame(animate);
        bloomPass.strength = document.querySelector('#bloom').value;
        if(charMesh) {
            // Simulējam AO caur materiāla intensitāti
            charMesh.material.emissiveIntensity = document.querySelector('#ao-strength').value;
        }
        composer.render();
    }

    init();
</script>
</body>
</html>